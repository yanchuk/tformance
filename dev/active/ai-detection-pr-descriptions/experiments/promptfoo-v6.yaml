# Promptfoo Configuration - v6.0.0 Enhanced Prompt
#
# Tests AI detection, tech detection, AND health assessment
# Run: npx promptfoo eval -c promptfoo-v6.yaml
# View: npx promptfoo view

description: "AI Detection Prompt Evaluation (v6) - With Health Assessment"

providers:
  - id: groq:llama-3.3-70b-versatile
    config:
      temperature: 0
      max_tokens: 800
      response_format:
        type: json_object

prompts:
  - id: v6
    raw: |
      [
        {"role": "system", "content": "{{system_prompt}}"},
        {"role": "user", "content": "Analyze this pull request:\n\n{{user_prompt}}"}
      ]

# Default variables
defaultTest:
  vars:
    system_prompt: file://prompts/v6-system.txt
  assert:
    - type: is-json
    - type: javascript
      value: |
        const r = JSON.parse(output);
        return typeof r.ai?.is_assisted === 'boolean' &&
               Array.isArray(r.ai?.tools) &&
               typeof r.ai?.confidence === 'number';

tests:
  # ============================================
  # AI DETECTION TESTS
  # ============================================

  - description: "Claude Code signature with health context"
    vars:
      user_prompt: |
        Title: Fix login validation bug
        State: merged
        Lines: +50/-10
        Cycle time: 2.5 hours
        Time to first review: 0.5 hours
        Comments: 3

        Description:
        Fix login validation bug.

        ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: Claude <noreply@anthropic.com>
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).ai.is_assisted === true
      - type: javascript
        value: JSON.parse(output).ai.tools.includes("claude")
      - type: javascript
        value: JSON.parse(output).health.scope === "small"
      - type: javascript
        value: JSON.parse(output).health.review_friction === "low"

  - description: "Cursor IDE with high review friction"
    vars:
      user_prompt: |
        Title: Major refactor of auth system
        State: merged
        Lines: +800/-300
        Cycle time: 120.5 hours
        Time to first review: 48.0 hours
        Comments: 25
        Commits after first review: 8
        Review rounds: 4

        Description:
        Complete refactor of authentication system.

        Used Cursor IDE for implementation.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).ai.is_assisted === true
      - type: javascript
        value: JSON.parse(output).ai.tools.includes("cursor")
      - type: javascript
        value: |
          // Scope should be large or xlarge for 1100 lines
          const scope = JSON.parse(output).health.scope;
          return scope === "large" || scope === "xlarge";
      - type: javascript
        value: JSON.parse(output).health.review_friction === "high"
      - type: javascript
        value: |
          // Risk should be medium or high for large refactors
          const risk = JSON.parse(output).health.risk_level;
          return risk === "medium" || risk === "high";

  - description: "No AI - small quick PR"
    vars:
      user_prompt: |
        Title: Fix typo in README
        State: merged
        Lines: +2/-2
        Files changed: 1
        Cycle time: 0.5 hours
        Time to first review: 0.2 hours
        Comments: 1

        Description:
        Fixed typo in installation instructions.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).ai.is_assisted === false
      - type: javascript
        value: JSON.parse(output).health.scope === "small"
      - type: javascript
        value: JSON.parse(output).health.risk_level === "low"

  # ============================================
  # TECHNOLOGY DETECTION TESTS
  # ============================================

  - description: "Python Django backend PR"
    vars:
      user_prompt: |
        Title: Add user authentication endpoint
        State: merged
        Lines: +250/-50
        Files: apps/auth/views.py, apps/auth/tests.py, apps/auth/models.py
        Repository languages: Python, TypeScript, Go

        Description:
        Added Django REST Framework authentication endpoints with JWT tokens.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).tech.languages.includes("python")
      - type: javascript
        value: JSON.parse(output).tech.frameworks.includes("django")
      - type: javascript
        value: JSON.parse(output).tech.categories.includes("backend")

  - description: "React TypeScript frontend PR"
    vars:
      user_prompt: |
        Title: Add dark mode toggle
        State: merged
        Lines: +180/-20
        Files: src/components/ThemeToggle.tsx, src/context/ThemeContext.tsx, src/App.tsx
        Repository languages: TypeScript, JavaScript, CSS

        Description:
        Implemented dark mode toggle with React context and Tailwind CSS.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).tech.languages.includes("typescript")
      - type: javascript
        value: JSON.parse(output).tech.frameworks.includes("react")
      - type: javascript
        value: JSON.parse(output).tech.categories.includes("frontend")

  - description: "Full-stack PR with multiple technologies"
    vars:
      user_prompt: |
        Title: Add real-time notifications
        State: merged
        Lines: +450/-80
        Files: apps/notifications/views.py, apps/notifications/consumers.py, frontend/src/components/NotificationBell.tsx, docker-compose.yml
        Repository languages: Python, TypeScript, JavaScript

        Description:
        Implemented real-time notifications using Django Channels and React.
        Added Redis for WebSocket layer and PostgreSQL for persistence.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).tech.languages.includes("python")
      - type: javascript
        value: JSON.parse(output).tech.languages.includes("typescript")
      - type: javascript
        value: JSON.parse(output).tech.frameworks.includes("django") || JSON.parse(output).tech.frameworks.includes("react")
      - type: javascript
        value: JSON.parse(output).tech.categories.includes("backend")
      - type: javascript
        value: JSON.parse(output).tech.categories.includes("frontend")

  # ============================================
  # HEALTH ASSESSMENT TESTS
  # ============================================

  - description: "Hotfix PR - high risk"
    vars:
      user_prompt: |
        Title: HOTFIX: Fix production crash on login
        State: merged
        Labels: hotfix, critical, production
        Hotfix: Yes
        Lines: +15/-5
        Cycle time: 0.5 hours
        Time to first review: 0.1 hours
        Comments: 2

        Description:
        Emergency fix for production login crash affecting all users.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).health.risk_level === "high" || JSON.parse(output).health.risk_level === "medium"
      - type: javascript
        value: JSON.parse(output).summary.type === "bugfix"

  - description: "Revert PR - indicates previous issue"
    vars:
      user_prompt: |
        Title: Revert "Add new payment flow"
        State: merged
        Labels: revert
        Revert: Yes
        Lines: +50/-300
        Cycle time: 1.0 hours

        Description:
        Reverting the new payment flow as it caused issues in production.
        This reverts commit abc123.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).health.risk_level === "high" || JSON.parse(output).health.risk_level === "medium"
      - type: javascript
        value: JSON.parse(output).health.insights.length > 0

  - description: "Large PR with many iterations - high friction"
    vars:
      user_prompt: |
        Title: Migrate database to PostgreSQL
        State: merged
        Lines: +1200/-800
        Files changed: 45
        Cycle time: 168.0 hours
        Time to first review: 72.0 hours
        Comments: 35
        Commits after first review: 12
        Review rounds: 5

        Description:
        Complete migration from MySQL to PostgreSQL.
        Updated all models, migrations, and queries.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).health.scope === "xlarge"
      - type: javascript
        value: JSON.parse(output).health.review_friction === "high"
      - type: javascript
        value: JSON.parse(output).health.risk_level === "high"

  - description: "Draft PR - work in progress"
    vars:
      user_prompt: |
        Title: WIP: Add payment integration
        State: open
        Draft: Yes
        Lines: +150/-0

        Description:
        Work in progress - adding Stripe payment integration.
        DO NOT MERGE YET.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).summary.type === "feature"

  # ============================================
  # EDGE CASES
  # ============================================

  - description: "Minimal info PR"
    vars:
      user_prompt: |
        Title: Update dependencies
        State: merged
        Lines: +10/-10

        Description:
        Updated npm packages.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).ai.is_assisted === false
      - type: javascript
        value: JSON.parse(output).summary.type === "chore"

  - description: "CI/CD changes"
    vars:
      user_prompt: |
        Title: Add GitHub Actions workflow
        State: merged
        Lines: +100/-0
        Files: .github/workflows/ci.yml, .github/workflows/deploy.yml

        Description:
        Added CI/CD pipeline with test, build, and deploy stages.
    assert:
      - type: is-json
      - type: javascript
        value: JSON.parse(output).summary.type === "ci"
      - type: javascript
        value: JSON.parse(output).tech.categories.includes("devops")

# Output configuration
outputPath: ./results/promptfoo-v6-results.json

# Evaluation settings
evaluateOptions:
  maxConcurrency: 5
  showProgressBar: true
