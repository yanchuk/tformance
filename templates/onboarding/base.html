{% extends "web/base.html" %}
{% load i18n %}

{% block top_nav %}
{# Minimal nav for onboarding - no team switcher #}
<nav class="app-navbar">
  <div class="flex-1">
    <a href="{% url 'web:home' %}" class="app-btn-ghost text-xl font-semibold">
      {% translate "AI Impact Analytics" %}
    </a>
  </div>
  <div class="flex items-center gap-4">
    <span class="text-sm text-base-content/70">{{ request.user.email }}</span>
    <form method="post" action="{% url 'account_logout' %}" class="inline">
      {% csrf_token %}
      <button type="submit" class="app-btn-ghost text-sm gap-2" aria-label="{% translate 'Log out' %}">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span class="hidden sm:inline">{% translate "Log out" %}</span>
      </button>
    </form>
  </div>
</nav>
{% endblock %}

{% block body %}
<div class="app-bg">
  {# Progress indicator #}
  <div class="w-full bg-base-200 border-b border-base-300 py-4">
    <div class="max-w-2xl mx-auto px-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-xs text-base-content/60">{% translate "Setup" %}</span>
        <span class="text-xs text-base-content/60"><i class="fa-regular fa-clock mr-1"></i>~5 min</span>
      </div>
      {# A-002: Dynamically show stepper steps based on enabled integrations #}
      {# Calculate total steps and Done step number #}
      {% with done_step=3|add:jira_enabled|add:slack_enabled %}
      <div class="app-steps">
        {# Step 1: GitHub #}
        <div class="app-step">
          <div class="app-step-indicator {% if step >= 1 %}app-step-indicator-active{% endif %}">1</div>
          <span class="app-step-label hidden sm:block {% if step >= 1 %}app-step-label-active{% endif %}">{% translate "GitHub" %}</span>
        </div>
        <div class="app-step-connector {% if step >= 2 %}app-step-connector-complete{% endif %}"></div>
        {# Step 2: Repositories #}
        <div class="app-step">
          <div class="app-step-indicator {% if step >= 2 %}app-step-indicator-active{% endif %}">2</div>
          <span class="app-step-label hidden sm:block {% if step >= 2 %}app-step-label-active{% endif %}">{% translate "Repos" %}</span>
        </div>
        {% if jira_enabled %}
        <div class="app-step-connector {% if step >= 3 %}app-step-connector-complete{% endif %}"></div>
        {# Step 3: Jira (optional - only shown when flag enabled) #}
        <div class="app-step">
          <div class="app-step-indicator {% if step >= 3 %}app-step-indicator-active{% endif %}">3</div>
          <span class="app-step-label hidden sm:block {% if step >= 3 %}app-step-label-active{% endif %}">
            {% translate "Jira" %}
            <span class="text-xs text-base-content/50 block">(optional)</span>
          </span>
        </div>
        {% endif %}
        {% if slack_enabled %}
        <div class="app-step-connector {% if step >= 4 %}app-step-connector-complete{% endif %}"></div>
        {# Step 4: Slack (optional - only shown when flag enabled) #}
        <div class="app-step">
          <div class="app-step-indicator {% if step >= 4 %}app-step-indicator-active{% endif %}">{% if jira_enabled %}4{% else %}3{% endif %}</div>
          <span class="app-step-label hidden sm:block {% if step >= 4 %}app-step-label-active{% endif %}">
            {% translate "Slack" %}
            <span class="text-xs text-base-content/50 block">(optional)</span>
          </span>
        </div>
        {% endif %}
        <div class="app-step-connector {% if step >= 5 %}app-step-connector-complete{% endif %}"></div>
        {# Final Step: Complete #}
        <div class="app-step">
          <div class="app-step-indicator {% if step >= 5 %}app-step-indicator-complete{% endif %}">
            {% if step >= 5 %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            {% else %}{{ done_step }}{% endif %}
          </div>
          <span class="app-step-label hidden sm:block {% if step >= 5 %}app-step-label-active{% endif %}">{% translate "Done" %}</span>
        </div>
      </div>
      {% endwith %}
    </div>
  </div>

  {# Background sync indicator - floating at bottom right #}
  {% if sync_task_id %}
  <div id="sync-indicator" class="fixed bottom-4 right-4 z-50 animate-bounce-in">
    <a href="{% url 'onboarding:sync_progress' %}"
       class="flex items-center gap-3 bg-base-200 border border-primary/30 rounded-lg px-4 py-3 shadow-lg hover:bg-base-300 hover:border-primary/50 transition-colors">
      <div class="relative">
        <i id="sync-icon" class="fa-solid fa-sync fa-spin text-primary"></i>
      </div>
      <div class="text-sm">
        <div class="font-medium text-base-content">{% translate "Syncing data..." %}</div>
        <div id="sync-status" class="text-base-content/70">{% translate "Running in background" %}</div>
      </div>
    </a>
  </div>
  <script>
  (function() {
    const taskId = "{{ sync_task_id }}";
    const progressUrl = '/celery-progress/' + taskId + '/';
    const indicator = document.getElementById('sync-indicator');
    const icon = document.getElementById('sync-icon');
    const status = document.getElementById('sync-status');

    function pollProgress() {
      fetch(progressUrl)
        .then(response => response.json())
        .then(data => {
          if (data.complete) {
            icon.classList.remove('fa-spin', 'fa-sync');
            icon.classList.add('fa-check', 'text-success');
            status.textContent = 'Sync complete!';
            // Hide after 5 seconds
            setTimeout(() => indicator.style.display = 'none', 5000);
          } else if (data.progress) {
            const percent = Math.round((data.progress.current / data.progress.total) * 100);
            status.textContent = percent + '% complete';
            setTimeout(pollProgress, 2000);
          } else {
            setTimeout(pollProgress, 2000);
          }
        })
        .catch(() => setTimeout(pollProgress, 3000));
    }
    pollProgress();
  })();
  </script>
  {% endif %}

  {# Jira background sync indicator - floating at bottom right #}
  {% if jira_sync_task_id %}
  <div id="jira-sync-indicator"
       class="fixed bottom-4 {% if sync_task_id %}right-80{% else %}right-4{% endif %} z-50 animate-bounce-in"
       x-data="{ status: 'syncing', issuesCount: 0 }"
       x-init="
         const poll = setInterval(async () => {
           try {
             const res = await fetch('{% url 'onboarding:jira_sync_status' %}');
             const data = await res.json();
             status = data.overall_status;
             issuesCount = data.issues_synced;
             if (status === 'completed' || status === 'error') {
               clearInterval(poll);
               setTimeout(() => { $el.style.display = 'none'; }, 5000);
             }
           } catch (e) {
             console.error('Jira sync poll error:', e);
           }
         }, 2000);
       ">
    <div class="flex items-center gap-3 bg-base-200 border border-accent/30 rounded-lg px-4 py-3 shadow-lg">
      <div class="relative">
        <i class="fa-brands fa-jira text-accent"
           :class="{ 'animate-pulse': status === 'syncing' || status === 'pending' }"></i>
        <template x-if="status === 'completed'">
          <i class="fa-solid fa-check-circle text-success absolute -top-1 -right-1 text-xs"></i>
        </template>
        <template x-if="status === 'error'">
          <i class="fa-solid fa-exclamation-circle text-error absolute -top-1 -right-1 text-xs"></i>
        </template>
      </div>
      <div class="text-sm">
        <div class="font-medium text-base-content">{% translate "Jira sync" %}</div>
        <div class="text-base-content/70">
          <template x-if="status === 'syncing' || status === 'pending'">
            <span><span x-text="issuesCount"></span> {% translate "issues synced..." %}</span>
          </template>
          <template x-if="status === 'completed'">
            <span class="text-success"><span x-text="issuesCount"></span> {% translate "issues synced" %}</span>
          </template>
          <template x-if="status === 'error'">
            <span class="text-error">{% translate "Sync failed" %}</span>
          </template>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {# Main content #}
  <div class="max-w-2xl mx-auto px-4 py-12">
    {% if messages %}
      {% for message in messages %}
        <div class="app-alert {% if message.tags == 'error' %}app-alert-error{% elif message.tags == 'success' %}app-alert-success{% else %}app-alert-info{% endif %} mb-6">
          <span>{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}

    {% block onboarding_content %}{% endblock %}
  </div>
</div>
{% endblock %}
