{% extends "web/app/app_base.html" %}
{% load static %}
{% load i18n %}
{% load partials %}
{% load django_vite %}
{% load pr_list_tags %}

{% block app %}
  {% partialdef page-content inline %}
  <div id="page-content" class="app-card">
    <!-- Header with title -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="pg-title">{% trans "Pull Requests" %}</h1>
    </div>

    <!-- Filters Panel -->
    <div class="bg-base-200 rounded-lg p-4 mb-6"
         x-data="{
           initial: {
             repo: '{{ filters.repo|default:"" }}',
             author: '{{ filters.author|default:"" }}',
             ai: '{{ filters.ai|default:"" }}',
             state: '{{ filters.state|default:"" }}',
             date_from: '{{ filters.date_from|default:"" }}',
             date_to: '{{ filters.date_to|default:"" }}'
           },
           current: {
             repo: '{{ filters.repo|default:"" }}',
             author: '{{ filters.author|default:"" }}',
             ai: '{{ filters.ai|default:"" }}',
             state: '{{ filters.state|default:"" }}',
             date_from: '{{ filters.date_from|default:"" }}',
             date_to: '{{ filters.date_to|default:"" }}'
           },
           get isDirty() {
             return this.current.repo !== this.initial.repo ||
                    this.current.author !== this.initial.author ||
                    this.current.ai !== this.initial.ai ||
                    this.current.state !== this.initial.state ||
                    this.current.date_from !== this.initial.date_from ||
                    this.current.date_to !== this.initial.date_to;
           },
           resetDirty() {
             this.initial = { ...this.current };
           }
         }"
         @htmx:after-request.window="resetDirty()">
      <form hx-get="{% url 'metrics:pr_list' %}"
            hx-target="#pr-table-container"
            hx-swap="innerHTML"
            hx-push-url="true"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

        <!-- Repository Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Repository" %}</span>
          </label>
          <select name="repo" class="select select-bordered select-sm w-full"
                  x-model="current.repo">
            <option value="">{% trans "All Repositories" %}</option>
            {% for repo in filter_options.repos %}
            <option value="{{ repo }}" {% if filters.repo == repo %}selected{% endif %}>{{ repo|repo_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Author Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Author" %}</span>
          </label>
          <select name="author" class="select select-bordered select-sm w-full"
                  x-model="current.author">
            <option value="">{% trans "All Authors" %}</option>
            {% for author in filter_options.authors %}
            <option value="{{ author.id }}" {% if filters.author == author.id %}selected{% endif %}>{{ author.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- AI Assisted Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "AI Assisted" %}</span>
          </label>
          <select name="ai" class="select select-bordered select-sm w-full"
                  x-model="current.ai">
            <option value="">{% trans "All" %}</option>
            <option value="yes" {% if filters.ai == 'yes' %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="no" {% if filters.ai == 'no' %}selected{% endif %}>{% trans "No" %}</option>
          </select>
        </div>

        <!-- State Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "State" %}</span>
          </label>
          <select name="state" class="select select-bordered select-sm w-full"
                  x-model="current.state">
            <option value="">{% trans "All States" %}</option>
            {% for state in filter_options.states %}
            <option value="{{ state }}" {% if filters.state == state %}selected{% endif %}>{{ state|title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Date From -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Date From" %}</span>
          </label>
          <input type="date" name="date_from" value="{{ filters.date_from|default:'' }}"
                 class="input input-bordered input-sm w-full"
                 x-model="current.date_from">
        </div>

        <!-- Date To -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Date To" %}</span>
          </label>
          <input type="date" name="date_to" value="{{ filters.date_to|default:'' }}"
                 class="input input-bordered input-sm w-full"
                 x-model="current.date_to">
        </div>

        <!-- Actions -->
        <div class="form-control lg:col-span-2 flex flex-row items-end gap-2">
          <button type="submit"
                  class="btn btn-primary btn-sm transition-all duration-200"
                  :class="{ 'ring-2 ring-warning/60 ring-offset-2 ring-offset-base-200': isDirty }">
            <span x-show="!isDirty">{% trans "Apply Filters" %}</span>
            <span x-show="isDirty" x-cloak>{% trans "Apply Changes" %}</span>
          </button>
          <a href="{% url 'metrics:pr_list' %}" class="btn btn-ghost btn-sm">
            {% trans "Clear" %}
          </a>
          <a href="{% url 'metrics:pr_list_export' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}"
             class="btn btn-outline btn-sm ml-auto">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            {% trans "Export CSV" %}
          </a>
        </div>
      </form>
    </div>

    <!-- Stats Row -->
    <div class="stats stats-horizontal shadow bg-base-200 w-full mb-6">
      <div class="stat">
        <div class="stat-title">{% trans "Total PRs" %}</div>
        <div class="stat-value text-2xl">{{ stats.total_count }}</div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "Avg Cycle Time" %}</div>
        <div class="stat-value text-2xl">
          {% if stats.avg_cycle_time %}
            {{ stats.avg_cycle_time|floatformat:1 }}h
          {% else %}
            -
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "Avg Review Time" %}</div>
        <div class="stat-value text-2xl">
          {% if stats.avg_review_time %}
            {{ stats.avg_review_time|floatformat:1 }}h
          {% else %}
            -
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "AI Assisted" %}</div>
        <div class="stat-value text-2xl">{{ stats.ai_assisted_count }}</div>
      </div>
    </div>

    <!-- PR Table -->
    <div id="pr-table-container">
      {% include "metrics/pull_requests/partials/table.html" %}
    </div>
  </div>
  {% endpartialdef page-content %}
{% endblock %}

{% block page_js %}
{% vite_asset 'assets/javascript/app.js' %}
{% endblock %}
