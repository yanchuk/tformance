{% load i18n %}
<div class="needs-attention-container">
  {% if summary %}
  <!-- Stacked Horizontal Bar with clickable segments -->
  <div class="mb-4">
    <div class="flex h-6 rounded-lg overflow-hidden bg-base-200">
      {% for item in summary %}
      <a href="{% url 'metrics:pr_list' %}?issue_type={{ item.type }}&days={{ days }}"
         class="flex items-center justify-center text-xs font-medium hover:opacity-80 cursor-pointer transition-opacity"
         style="width: {{ item.percent }}%; background-color: {{ item.color }};"
         title="{{ item.tooltip }}">
        {% if item.percent > 8 %}{{ item.count }}{% endif %}
      </a>
      {% endfor %}
    </div>
    <!-- Legend with links and tooltips -->
    <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
      {% for item in summary %}
      <a href="{% url 'metrics:pr_list' %}?issue_type={{ item.type }}&days={{ days }}"
         class="flex items-center gap-1 hover:text-primary transition-colors"
         title="{{ item.tooltip }}">
        <span class="w-3 h-3 rounded-sm" style="background-color: {{ item.color }};"></span>
        <span class="text-base-content/70">{{ item.label }}</span>
        <span class="font-bold tabular-nums">{{ item.count }}</span>
      </a>
      {% endfor %}
      <div class="flex items-center gap-1 ml-auto">
        <span class="text-base-content/50">{% trans "Total" %}:</span>
        <span class="font-bold tabular-nums">{{ total_count }}</span>
      </div>
    </div>
  </div>

  {% if prs %}
  <!-- Most Critical PR -->
  <div class="pt-3 border-t border-base-300">
    <div class="text-xs text-base-content/50 mb-1">{% trans "Most Critical" %}</div>
    {% with pr=prs.0 %}
    <a href="{{ pr.url }}" target="_blank" class="flex items-start gap-2 hover:bg-base-200 rounded p-1 -m-1 group">
      <span class="w-3 h-3 rounded-sm mt-1 flex-shrink-0" style="background-color: {% if pr.issue_priority == 1 %}#ef4444{% elif pr.issue_priority == 2 %}#f59e0b{% elif pr.issue_priority == 3 %}#06b6d4{% elif pr.issue_priority == 4 %}#8b5cf6{% else %}#6b7280{% endif %};"></span>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-0.5">
          <span class="badge badge-xs px-1.5 py-0.5"
                style="background-color: {% if pr.issue_priority == 1 %}#ef4444{% elif pr.issue_priority == 2 %}#f59e0b{% elif pr.issue_priority == 3 %}#06b6d4{% elif pr.issue_priority == 4 %}#8b5cf6{% else %}#6b7280{% endif %}; color: white;">
            {% if pr.issue_type == "revert" %}{% trans "Revert" %}{% elif pr.issue_type == "hotfix" %}{% trans "Hotfix" %}{% elif pr.issue_type == "long_cycle" %}{% trans "Slow" %}{% elif pr.issue_type == "large_pr" %}{% trans "Large" %}{% else %}{% trans "No Jira" %}{% endif %}
          </span>
          <span class="text-xs text-base-content/50">
            {% if pr.issue_type == "revert" %}{% trans "Rolled-back changes need review" %}{% elif pr.issue_type == "hotfix" %}{% trans "Emergency fix bypassed review" %}{% elif pr.issue_type == "long_cycle" %}{% trans "Slower than 2x team average" %}{% elif pr.issue_type == "large_pr" %}{% trans ">500 lines changed" %}{% else %}{% trans "Missing ticket reference" %}{% endif %}
          </span>
        </div>
        <div class="text-sm text-base-content group-hover:text-primary line-clamp-1">{{ pr.title }}</div>
        <div class="text-xs text-base-content/60">{{ pr.author }}</div>
      </div>
    </a>
    {% endwith %}
  </div>
  {% endif %}

  {% else %}
  <!-- Empty State -->
  <div class="flex flex-col items-center justify-center py-6">
    <div class="w-10 h-10 mb-2 rounded-full bg-success/10 flex items-center justify-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <p class="text-base-content/80 font-medium text-sm">{% trans "All Clear!" %}</p>
    <p class="text-base-content/60 text-xs">{% trans "No PRs need attention" %}</p>
  </div>
  {% endif %}
</div>
