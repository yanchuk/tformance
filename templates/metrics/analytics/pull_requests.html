{% extends "metrics/analytics/base_analytics.html" %}
{% load static %}
{% load i18n %}
{% load partials %}
{% load pr_list_tags %}

{% block analytics_content %}
  {% partialdef page-content inline %}
  <div id="page-content" class="min-w-0 overflow-hidden">
    <!-- Header with title and export button -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="pg-title">{% trans "Pull Requests" %}</h1>
      <a href="{% url 'metrics:pr_list_export' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}"
         class="btn btn-outline btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        {% trans "Export CSV" %}
      </a>
    </div>

    <!-- Filters Panel -->
    <div class="bg-base-200 rounded-lg p-4 mb-6 min-w-0">
      <form hx-get="{% url 'metrics:pr_list' %}"
            hx-target="#page-content"
            hx-swap="outerHTML"
            hx-push-url="true"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 min-w-0">

        <!-- Repository Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Repository" %}</span>
          </label>
          <select name="repo" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All Repositories" %}</option>
            {% for repo in filter_options.repos %}
            <option value="{{ repo }}" {% if filters.repo == repo %}selected{% endif %}>{{ repo|repo_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Author Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Author" %}</span>
          </label>
          <select name="author" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All Authors" %}</option>
            {% for author in filter_options.authors %}
            <option value="{{ author.id }}" {% if filters.author == author.id %}selected{% endif %}>{{ author.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Reviewer Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Reviewer" %}</span>
          </label>
          <select name="reviewer" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All Reviewers" %}</option>
            {% for reviewer in filter_options.reviewers %}
            <option value="{{ reviewer.id }}" {% if filters.reviewer == reviewer.id %}selected{% endif %}>{{ reviewer.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- AI Assisted Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "AI Assisted" %}</span>
          </label>
          <select name="ai" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All" %}</option>
            <option value="yes" {% if filters.ai == 'yes' %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="no" {% if filters.ai == 'no' %}selected{% endif %}>{% trans "No" %}</option>
          </select>
        </div>

        <!-- AI Tool Filter -->
        {% if filter_options.ai_tools %}
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "AI Tool" %}</span>
          </label>
          <select name="ai_tool" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All Tools" %}</option>
            {% for tool in filter_options.ai_tools %}
            <option value="{{ tool }}" {% if filters.ai_tool == tool %}selected{% endif %}>{{ tool }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- State Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "State" %}</span>
          </label>
          <select name="state" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All States" %}</option>
            {% for state in filter_options.states %}
            <option value="{{ state }}" {% if filters.state == state %}selected{% endif %}>{{ state|title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- PR Size Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "PR Size" %}</span>
          </label>
          <select name="size" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All Sizes" %}</option>
            <option value="XS" {% if filters.size == 'XS' %}selected{% endif %}>XS (0-10 lines)</option>
            <option value="S" {% if filters.size == 'S' %}selected{% endif %}>S (11-50 lines)</option>
            <option value="M" {% if filters.size == 'M' %}selected{% endif %}>M (51-200 lines)</option>
            <option value="L" {% if filters.size == 'L' %}selected{% endif %}>L (201-500 lines)</option>
            <option value="XL" {% if filters.size == 'XL' %}selected{% endif %}>XL (501+ lines)</option>
          </select>
        </div>

        <!-- Technology Filter (Multi-select) -->
        <div class="form-control"
             x-data="{
               open: false,
               selected: [{% for t in filters.tech %}'{{ t }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
               toggle(val) {
                 const idx = this.selected.indexOf(val);
                 if (idx > -1) { this.selected.splice(idx, 1); }
                 else { this.selected.push(val); }
               }
             }">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Technology" %}</span>
          </label>
          <div class="dropdown w-full" :class="{ 'dropdown-open': open }">
            <div tabindex="0" role="button"
                 class="select select-bordered select-sm w-full flex items-center justify-between"
                 @click="open = !open">
              <span x-text="selected.length ? selected.length + ' selected' : 'All Technologies'"></span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-200 rounded-box z-50 w-full p-2 shadow" @click.outside="open = false">
              {% for cat in filter_options.tech_categories %}
              <li>
                <label class="label cursor-pointer justify-start gap-2 py-1">
                  <input type="checkbox" name="tech" value="{{ cat.value }}"
                         class="checkbox checkbox-sm checkbox-primary"
                         :checked="selected.includes('{{ cat.value }}')"
                         @change="toggle('{{ cat.value }}')">
                  <span class="label-text">{{ cat.label }}</span>
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Has Jira Link Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Jira Link" %}</span>
          </label>
          <select name="has_jira" class="select select-bordered select-sm w-full">
            <option value="">{% trans "All" %}</option>
            <option value="yes" {% if filters.has_jira == 'yes' %}selected{% endif %}>{% trans "Has Jira" %}</option>
            <option value="no" {% if filters.has_jira == 'no' %}selected{% endif %}>{% trans "No Jira" %}</option>
          </select>
        </div>

        <!-- Date From -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Date From" %}</span>
          </label>
          <input type="date" name="date_from" value="{{ filters.date_from|default:'' }}"
                 class="input input-bordered input-sm w-full">
        </div>

        <!-- Date To -->
        <div class="form-control">
          <label class="label">
            <span class="label-text text-base-content/80">{% trans "Date To" %}</span>
          </label>
          <input type="date" name="date_to" value="{{ filters.date_to|default:'' }}"
                 class="input input-bordered input-sm w-full">
        </div>

        <!-- Actions -->
        <div class="form-control lg:col-span-2 flex flex-row items-end gap-2">
          <button type="submit" class="btn btn-primary btn-sm">
            {% trans "Apply Filters" %}
          </button>
          <a href="{% url 'metrics:pr_list' %}" class="btn btn-ghost btn-sm">
            {% trans "Clear" %}
          </a>
        </div>
      </form>
    </div>

    <!-- Stats Row -->
    <div class="overflow-x-auto min-w-0 mb-6">
    <div class="stats stats-horizontal shadow bg-base-200 w-full min-w-0">
      <div class="stat">
        <div class="stat-title">{% trans "Total PRs" %}</div>
        <div class="stat-value text-2xl">{{ stats.total_count }}</div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "Avg Cycle Time" %}</div>
        <div class="stat-value text-2xl">
          {% if stats.avg_cycle_time %}
            {{ stats.avg_cycle_time|floatformat:1 }}h
          {% else %}
            -
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "Avg Review Time" %}</div>
        <div class="stat-value text-2xl">
          {% if stats.avg_review_time %}
            {{ stats.avg_review_time|floatformat:1 }}h
          {% else %}
            -
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-title">{% trans "AI Assisted" %}</div>
        <div class="stat-value text-2xl">{{ stats.ai_assisted_count }}</div>
      </div>
    </div>
    </div>

    <!-- PR Table -->
    <div id="pr-table-container" class="min-w-0">
      {% include "metrics/pull_requests/partials/table.html" %}
    </div>
  </div>
  {% endpartialdef page-content %}
{% endblock %}
