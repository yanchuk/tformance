{% extends "web/app/app_base.html" %}
{% load static %}
{% load i18n %}
{% load partials %}
{% load django_vite %}

{% block app %}
<div class="app-card">
  <!-- Analytics Header with tabs and date filter -->
  <div class="flex flex-col gap-4 mb-6">
    <!-- Tab Navigation -->
    <div role="tablist" class="tabs tabs-boxed bg-base-200 w-fit">
      <a role="tab"
         href="{% url 'metrics:analytics_overview' %}"
         class="tab {% if active_page == 'overview' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:analytics_overview' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "Overview" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:analytics_ai_adoption' %}"
         class="tab {% if active_page == 'ai_adoption' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:analytics_ai_adoption' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "AI Adoption" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:analytics_delivery' %}"
         class="tab {% if active_page == 'delivery' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:analytics_delivery' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "Delivery" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:analytics_quality' %}"
         class="tab {% if active_page == 'quality' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:analytics_quality' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "Quality" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:analytics_team' %}"
         class="tab {% if active_page == 'team' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:analytics_team' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "Team" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:trends_overview' %}"
         class="tab {% if active_page == 'trends' %}tab-active{% endif %}"
         hx-get="{% url 'metrics:trends_overview' %}?days={{ days }}"
         hx-target="#page-content"
         hx-swap="outerHTML"
         hx-push-url="true">
        {% trans "Trends" %}
      </a>
      <a role="tab"
         href="{% url 'metrics:pr_list' %}"
         class="tab {% if active_page == 'pull_requests' %}tab-active{% endif %}">
        {% trans "Pull Requests" %}
      </a>
    </div>

    <!-- Date Range Filter Container (updated via OOB swap on HTMX navigation) -->
    <div id="date-range-picker-container">
      {% if active_page != 'pull_requests' %}
      <div class="flex gap-2 items-center">
        <span class="text-sm text-base-content/70">{% trans "Time range:" %}</span>
        {% include "metrics/partials/date_range_picker.html" with days=days start_date=start_date end_date=end_date preset=preset %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Page Content (for HTMX partial replacement) -->
  {% block analytics_content %}
  {% endblock %}
</div>
{% endblock %}

{% block page_js %}
{% vite_asset 'assets/javascript/app.js' %}
<script>
  // Update active tab indicator after HTMX navigation
  function updateActiveTab() {
    const path = window.location.pathname;
    const tabs = document.querySelectorAll('[role="tablist"] [role="tab"]');

    tabs.forEach(tab => {
      const href = tab.getAttribute('href');
      if (!href) return;

      // Check if tab href matches current path
      const tabPath = href.split('?')[0]; // Remove query params
      const isActive = path === tabPath || path.startsWith(tabPath + '/') ||
        (tabPath.endsWith('/') && path === tabPath.slice(0, -1));

      if (isActive) {
        tab.classList.add('tab-active');
      } else {
        tab.classList.remove('tab-active');
      }
    });
  }

  // Update time range button highlighting after HTMX navigation
  function updateTimeRangeButtons() {
    const params = new URLSearchParams(window.location.search);
    const days = parseInt(params.get('days')) || 30;

    document.querySelectorAll('.join a[href^="?days="]').forEach(btn => {
      const btnHref = btn.getAttribute('href');
      const btnDays = parseInt(new URLSearchParams(btnHref.split('?')[1]).get('days'));

      if (btnDays === days) {
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-ghost');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-ghost');
      }
    });
  }

  // Listen for HTMX URL changes
  document.body.addEventListener('htmx:pushedIntoHistory', function() {
    updateActiveTab();
    updateTimeRangeButtons();
  });
  document.body.addEventListener('htmx:replacedInHistory', function() {
    updateActiveTab();
    updateTimeRangeButtons();
  });

  // Also handle browser back/forward
  window.addEventListener('popstate', function() {
    updateActiveTab();
    updateTimeRangeButtons();
  });
</script>
{% endblock %}
