{% load i18n %}
{% load wagtailcore_tags %}
{% slugurl 'blog' as blog_url %}
<div class="navbar shadow-md px-4 lg:px-6">
  <div class="navbar-start">
    {# Mobile menu - Alpine.js controlled for reliable touch handling on iOS Safari #}
    <div class="lg:hidden relative" x-data="{ open: false }">
      <button @click="open = !open"
              class="btn btn-ghost"
              aria-label="Toggle menu"
              :aria-expanded="open">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
        </svg>
      </button>

      <ul x-show="open"
          x-cloak
          x-transition:enter="transition ease-out duration-150"
          x-transition:enter-start="opacity-0 scale-95"
          x-transition:enter-end="opacity-100 scale-100"
          x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="opacity-100 scale-100"
          x-transition:leave-end="opacity-0 scale-95"
          @click.outside="open = false"
          @touchstart.outside="open = false"
          @keydown.escape.window="open = false"
          class="menu menu-compact absolute left-0 top-full mt-3 p-2 shadow-lg bg-base-100 isolate rounded-box w-64 max-w-[calc(100vw_-_2rem)] z-50">
        {% block mobile_nav %}
        <li>
          <a @click="open = false" class="{% if request.path == '/' %}active{% endif %}" href="{% url 'web:home' %}">
            Home
          </a>
        </li>
        {# Dashboard Section #}
        <li class="menu-title text-xs pt-2 text-primary/70">Dashboard</li>
        <li>
          <a @click="open = false" href="{% url 'web:features_dashboard' %}">
            <i class="fa-solid fa-chart-pie fa-fw text-primary"></i>
            Dashboard & Insights
          </a>
        </li>
        {# Analytics Section #}
        <li class="menu-title text-xs pt-2 text-primary/70">Analytics</li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#overview">
            <i class="fa-solid fa-chart-line fa-fw text-primary"></i>
            Overview
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#ai-adoption">
            <i class="fa-solid fa-robot fa-fw text-primary"></i>
            AI Adoption
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#delivery">
            <i class="fa-solid fa-rocket fa-fw text-primary"></i>
            Delivery
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#quality">
            <i class="fa-solid fa-check-circle fa-fw text-primary"></i>
            Quality
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#team">
            <i class="fa-solid fa-users fa-fw text-primary"></i>
            Team
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features_analytics' %}#trends">
            <i class="fa-solid fa-chart-area fa-fw text-primary"></i>
            Trends
          </a>
        </li>
        {# Data Section #}
        <li class="menu-title text-xs pt-2 text-primary/70">Data</li>
        <li>
          <a @click="open = false" href="{% url 'web:features_pr_explorer' %}">
            <i class="fa-solid fa-list fa-fw text-primary"></i>
            PR Explorer
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'web:features' %}#integrations">
            <i class="fa-solid fa-plug fa-fw text-primary"></i>
            Integrations
          </a>
        </li>
        <li class="divider my-1"></li>
        <li>
          <a @click="open = false" href="{% url 'web:compare' %}">
            <i class="fa-solid fa-code-compare fa-fw text-primary"></i>
            Compare Tools
          </a>
        </li>
        <li class="menu-title text-xs pt-2">Resources</li>
        <li>
          <a @click="open = false" class="{% if request.path == '/pricing/' %}active{% endif %}" href="{% url 'web:pricing' %}">
            Pricing
          </a>
        </li>
        {% if blog_url %}
        <li>
          <a @click="open = false" class="{% if blog_url in request.path %}active{% endif %}" href="{{ blog_url }}">
            Blog
          </a>
        </li>
        {% endif %}
        {# Auth links for mobile - visible only when logged out #}
        {% if not user.is_authenticated %}
        <li class="divider my-1"></li>
        <li>
          <a @click="open = false" href="{% url 'account_signup' %}" class="text-primary font-semibold">
            Sign Up
          </a>
        </li>
        <li>
          <a @click="open = false" href="{% url 'account_login' %}">
            Sign In
          </a>
        </li>
        {% endif %}
        {% endblock %}
      </ul>
    </div>

    {# Logo - visible on all screen sizes #}
    <a href="{% url 'web:home' %}" class="flex items-center gap-2 ml-2 lg:ml-0">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-primary to-pink-500
                  flex items-center justify-center shadow-lg shadow-accent-primary/20">
        <span class="font-bold text-white text-sm">T</span>
      </div>
      <span class="font-bold text-xl lg:text-2xl tracking-tight font-sans">{{project_meta.NAME|title}}</span>
    </a>
  </div>

  {# Desktop navigation links #}
  <div class="navbar-center hidden lg:flex">
    <nav class="flex items-center gap-1" aria-label="Main navigation">
      {# Features Dropdown #}
      <div class="relative"
           x-data="{ open: false }"
           @mouseenter="open = true"
           @mouseleave="open = false"
           @keydown.escape="open = false">
        <button @click="open = !open"
                :aria-expanded="open"
                aria-haspopup="true"
                class="btn btn-ghost btn-sm gap-1 {% if '/features/' in request.path %}font-bold{% endif %}">
          Features
          <svg class="w-3 h-3 opacity-70 transition-transform" :class="{ 'rotate-180': open }"
               fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div x-show="open"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             @click.outside="open = false"
             class="absolute left-0 mt-1 p-5 shadow-lg bg-base-100 rounded-box w-[520px] z-50 border border-base-300"
             role="menu">
          {# 3-column mega menu #}
          <div class="grid grid-cols-3 gap-6">
            {# Column 1: Dashboard #}
            <div>
              <h3 class="text-xs font-semibold text-base-content/50 uppercase tracking-wider mb-3">Dashboard</h3>
              <a href="{% url 'web:features_dashboard' %}" role="menuitem"
                 class="block py-2 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                <span class="flex items-center gap-2 font-medium text-base-content text-sm">
                  <i class="fa-solid fa-chart-pie fa-fw text-primary"></i>
                  Dashboard & Insights
                </span>
                <span class="text-xs text-base-content/60 ml-6">Weekly reports</span>
              </a>
            </div>

            {# Column 2: Analytics #}
            <div>
              <h3 class="text-xs font-semibold text-base-content/50 uppercase tracking-wider mb-3">Analytics</h3>
              <div class="space-y-1">
                <a href="{% url 'web:features_analytics' %}#overview" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-chart-line fa-fw text-primary text-sm"></i>
                    Overview
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">Team health</span>
                </a>
                <a href="{% url 'web:features_analytics' %}#ai-adoption" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-robot fa-fw text-primary text-sm"></i>
                    AI Adoption
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">AI vs traditional</span>
                </a>
                <a href="{% url 'web:features_analytics' %}#delivery" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-rocket fa-fw text-primary text-sm"></i>
                    Delivery
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">Cycle time</span>
                </a>
                <a href="{% url 'web:features_analytics' %}#quality" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-check-circle fa-fw text-primary text-sm"></i>
                    Quality
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">Revert rate</span>
                </a>
                <a href="{% url 'web:features_analytics' %}#team" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-users fa-fw text-primary text-sm"></i>
                    Team
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">Reviewer load</span>
                </a>
                <a href="{% url 'web:features_analytics' %}#trends" role="menuitem"
                   class="block py-1.5 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 text-sm text-base-content">
                    <i class="fa-solid fa-chart-area fa-fw text-primary text-sm"></i>
                    Trends
                  </span>
                  <span class="text-xs text-base-content/50 ml-6">Long-term view</span>
                </a>
              </div>
            </div>

            {# Column 3: Data #}
            <div>
              <h3 class="text-xs font-semibold text-base-content/50 uppercase tracking-wider mb-3">Data</h3>
              <div class="space-y-1">
                <a href="{% url 'web:features_pr_explorer' %}" role="menuitem"
                   class="block py-2 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 font-medium text-base-content text-sm">
                    <i class="fa-solid fa-list fa-fw text-primary"></i>
                    PR Explorer
                  </span>
                  <span class="text-xs text-base-content/60 ml-6">Filter, export</span>
                </a>
                <a href="{% url 'web:features' %}#integrations" role="menuitem"
                   class="block py-2 hover:bg-base-200 rounded-lg px-2 -mx-2 transition-colors">
                  <span class="flex items-center gap-2 font-medium text-base-content text-sm">
                    <i class="fa-solid fa-plug fa-fw text-primary"></i>
                    Integrations
                  </span>
                  <span class="text-xs text-base-content/60 ml-6">GitHub + more</span>
                </a>
              </div>
            </div>
          </div>

          <div class="divider my-3"></div>
          <a href="{% url 'web:compare' %}" role="menuitem"
             class="btn btn-ghost btn-sm w-full justify-between text-base-content/80 hover:text-base-content">
            Compare Tools
            <i class="fa-solid fa-arrow-right text-xs"></i>
          </a>
        </div>
      </div>

      <a class="btn btn-ghost btn-sm {% if '/pricing/' in request.path %}font-bold{% endif %}" href="{% url 'web:pricing' %}">
        Pricing
      </a>

      {% if blog_url %}
      <a class="btn btn-ghost btn-sm {% if blog_url in request.path %}font-bold{% endif %}" href="{{ blog_url }}">
        Blog
      </a>
      {% endif %}
    </nav>
  </div>

  {# Auth buttons - hidden on mobile (available in mobile menu instead) #}
  <div class="navbar-end gap-2 hidden sm:flex">
    {% if not user.is_authenticated %}
    <a href="{% url 'account_signup' %}" class="btn btn-primary">
      Sign Up
    </a>
    <a href="{% url 'account_login' %}" class="btn btn-outline ml-2">
      Sign In
    </a>
    {% endif %}
  </div>
</div>
